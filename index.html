<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£›é¼ é›»å•†è‡ªå‹•åŒ–ç›£æ§å„€è¡¨æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #2c5aa0;
            text-align: center;
            margin-bottom: 10px;
        }

        .header p {
            text-align: center;
            color: #666;
        }

        .security-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 5px solid #f39c12;
        }

        .security-warning h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .security-warning p {
            color: #856404;
            font-size: 14px;
        }

        .config-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .config-section h2 {
            color: #2c5aa0;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e3f2fd;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #2c5aa0;
        }

        .form-group input[type="password"] {
            font-family: monospace;
        }

        .btn {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3d72 100%);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(44, 90, 160, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            text-align: center;
            transition: transform 0.3s;
        }

        .status-card:hover {
            transform: translateY(-5px);
        }

        .status-card h3 {
            color: #2c5aa0;
            margin-bottom: 10px;
        }

        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
        }

        .status-online {
            background: #27ae60;
            box-shadow: 0 0 10px rgba(39, 174, 96, 0.5);
        }

        .status-offline {
            background: #e74c3c;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
        }

        .status-warning {
            background: #f39c12;
            box-shadow: 0 0 10px rgba(243, 156, 18, 0.5);
        }

        .log-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-error { color: #ff6b6b; }
        .log-warning { color: #ffd93d; }
        .log-success { color: #6bcf7f; }
        .log-info { color: #74c0fc; }

        .hidden {
            display: none;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .processing {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸª é£›é¼ é›»å•†è‡ªå‹•åŒ–ç›£æ§ç³»çµ±</h1>
            <p>åŸºæ–¼ n8nã€Browserless.io å’Œ Google Sheets çš„å®Œæ•´è‡ªå‹•åŒ–è§£æ±ºæ–¹æ¡ˆ</p>
        </div>

        <div class="security-warning">
            <h3>ğŸ”’ å®‰å…¨æé†’</h3>
            <p>è«‹ç¢ºä¿æ‚¨å·²æ›´æ”¹æ‰€æœ‰åœ¨æ­¤è™•ä½¿ç”¨çš„å¯†ç¢¼å’Œ API é‡‘é‘°ã€‚æœ¬ç³»çµ±å°‡æ†‘è­‰å­˜å„²åœ¨ç€è¦½å™¨æœ¬åœ°ï¼Œä¸æœƒä¸Šå‚³åˆ°ä»»ä½•æœå‹™å™¨ã€‚</p>
        </div>

        <div class="config-section">
            <h2>âš™ï¸ ç³»çµ±é…ç½®</h2>
            <div class="form-group">
                <label for="feishu-email">é£›é¼ é›»å•†å¸³è™Ÿ (Email)</label>
                <input type="email" id="feishu-email" placeholder="è«‹è¼¸å…¥é£›é¼ é›»å•†ç™»å…¥ Email">
            </div>
            <div class="form-group">
                <label for="feishu-password">é£›é¼ é›»å•†å¯†ç¢¼</label>
                <input type="password" id="feishu-password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
            </div>
            <div class="form-group">
                <label for="browserless-api">Browserless.io API Key</label>
                <input type="password" id="browserless-api" placeholder="è«‹è¼¸å…¥ Browserless.io API Key">
            </div>
            <div class="form-group">
                <label for="sheets-api">Google Sheets API Key</label>
                <input type="password" id="sheets-api" placeholder="è«‹è¼¸å…¥ Google Sheets API Key">
            </div>
            <div class="form-group">
                <label for="sheets-id">Google Sheets ID</label>
                <input type="text" id="sheets-id" placeholder="è«‹è¼¸å…¥ Google Sheets æª”æ¡ˆ ID">
            </div>
            <button class="btn" onclick="saveConfig()">ğŸ’¾ å„²å­˜é…ç½®</button>
            <button class="btn btn-success" onclick="testConnection()">ğŸ” æ¸¬è©¦é€£æ¥</button>
        </div>

        <div class="status-grid">
            <div class="status-card">
                <h3>é£›é¼ é›»å•†é€£æ¥</h3>
                <div id="feishu-status">
                    <span class="status-indicator status-offline"></span>
                    <span>æœªé€£æ¥</span>
                </div>
                <p id="feishu-last-check">æœ€å¾Œæª¢æŸ¥: å¾æœª</p>
            </div>
            <div class="status-card">
                <h3>Browserless æœå‹™</h3>
                <div id="browserless-status">
                    <span class="status-indicator status-offline"></span>
                    <span>æœªé€£æ¥</span>
                </div>
                <p id="browserless-last-check">æœ€å¾Œæª¢æŸ¥: å¾æœª</p>
            </div>
            <div class="status-card">
                <h3>Google Sheets</h3>
                <div id="sheets-status">
                    <span class="status-indicator status-offline"></span>
                    <span>æœªé€£æ¥</span>
                </div>
                <p id="sheets-last-check">æœ€å¾Œæª¢æŸ¥: å¾æœª</p>
            </div>
            <div class="status-card">
                <h3>è‡ªå‹•åŒ–ç‹€æ…‹</h3>
                <div id="automation-status">
                    <span class="status-indicator status-offline"></span>
                    <span>åœæ­¢</span>
                </div>
                <p id="automation-last-run">æœ€å¾ŒåŸ·è¡Œ: å¾æœª</p>
            </div>
        </div>

        <div class="config-section">
            <h2>ğŸš€ æ§åˆ¶é¢æ¿</h2>
            <button class="btn btn-success" onclick="startAutomation()">â–¶ï¸ é–‹å§‹è‡ªå‹•åŒ–</button>
            <button class="btn btn-danger" onclick="stopAutomation()">â¹ï¸ åœæ­¢è‡ªå‹•åŒ–</button>
            <button class="btn" onclick="runProductScraping()">ğŸ“¦ æ‰‹å‹•æŠ“å–å•†å“</button>
            <button class="btn" onclick="runInventoryCheck()">ğŸ“Š æª¢æŸ¥åº«å­˜</button>
            <button class="btn" onclick="generateReport()">ğŸ“‹ ç”Ÿæˆå ±è¡¨</button>
            <button class="btn" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…é™¤æ—¥èªŒ</button>
        </div>

        <div class="log-section">
            <h2>ğŸ“ ç³»çµ±æ—¥èªŒ</h2>
            <div class="log-container" id="log-container">
                <div class="log-entry log-info">[ç³»çµ±] é£›é¼ é›»å•†è‡ªå‹•åŒ–ç³»çµ±å·²å•Ÿå‹•</div>
                <div class="log-entry log-warning">[è­¦å‘Š] è«‹å…ˆé…ç½®ç³»çµ±è¨­å®š</div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šæ•¸
        let automationRunning = false;
        let config = {};

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            addLog('info', 'ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
        });

        // é…ç½®ç®¡ç†
        function saveConfig() {
            config = {
                feishuEmail: document.getElementById('feishu-email').value,
                feishuPassword: document.getElementById('feishu-password').value,
                browserlessApi: document.getElementById('browserless-api').value,
                sheetsApi: document.getElementById('sheets-api').value,
                sheetsId: document.getElementById('sheets-id').value
            };

            // å„²å­˜åˆ°æœ¬åœ°å­˜å„²ï¼ˆåƒ…é™æ¼”ç¤ºç”¨é€”ï¼‰
            localStorage.setItem('feishu_automation_config', JSON.stringify(config));
            addLog('success', 'é…ç½®å·²å„²å­˜åˆ°æœ¬åœ°');
        }

        function loadConfig() {
            const saved = localStorage.getItem('feishu_automation_config');
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('feishu-email').value = config.feishuEmail || '';
                document.getElementById('feishu-password').value = config.feishuPassword || '';
                document.getElementById('browserless-api').value = config.browserlessApi || '';
                document.getElementById('sheets-api').value = config.sheetsApi || '';
                document.getElementById('sheets-id').value = config.sheetsId || '';
                addLog('info', 'å·²è¼‰å…¥å„²å­˜çš„é…ç½®');
            }
        }

        // é€£æ¥æ¸¬è©¦
        async function testConnection() {
            addLog('info', 'é–‹å§‹æ¸¬è©¦å„é …æœå‹™é€£æ¥...');
            
            await testBrowserlessConnection();
            await testSheetsConnection();
            await testFeishuConnection();
        }

        async function testBrowserlessConnection() {
            try {
                if (!config.browserlessApi) {
                    throw new Error('æœªè¨­å®š Browserless API Key');
                }

                addLog('info', 'æ¸¬è©¦ Browserless.io é€£æ¥...');
                
                const response = await fetch('https://chrome.browserless.io/json/version', {
                    headers: {
                        'Authorization': `Bearer ${config.browserlessApi}`
                    }
                });

                if (response.ok) {
                    updateStatus('browserless', 'online', 'é€£æ¥æ­£å¸¸');
                    addLog('success', 'Browserless.io é€£æ¥æˆåŠŸ');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateStatus('browserless', 'offline', 'é€£æ¥å¤±æ•—');
                addLog('error', `Browserless.io é€£æ¥å¤±æ•—: ${error.message}`);
            }
        }

        async function testSheetsConnection() {
            try {
                if (!config.sheetsApi || !config.sheetsId) {
                    throw new Error('æœªè¨­å®š Google Sheets API Key æˆ– Sheets ID');
                }

                addLog('info', 'æ¸¬è©¦ Google Sheets é€£æ¥...');
                
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${config.sheetsId}?key=${config.sheetsApi}`);

                if (response.ok) {
                    updateStatus('sheets', 'online', 'é€£æ¥æ­£å¸¸');
                    addLog('success', 'Google Sheets é€£æ¥æˆåŠŸ');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateStatus('sheets', 'offline', 'é€£æ¥å¤±æ•—');
                addLog('error', `Google Sheets é€£æ¥å¤±æ•—: ${error.message}`);
            }
        }

        async function testFeishuConnection() {
            try {
                if (!config.feishuEmail || !config.feishuPassword) {
                    throw new Error('æœªè¨­å®šé£›é¼ é›»å•†ç™»å…¥è³‡è¨Š');
                }

                addLog('info', 'æ¸¬è©¦é£›é¼ é›»å•†é€£æ¥...');

                // ä½¿ç”¨ Browserless.io é€²è¡Œç™»å…¥æ¸¬è©¦
                const browserlessRequest = {
                    url: 'https://www.feishu.com.tw/login',
                    actions: [
                        {
                            type: 'type',
                            selector: '#username',
                            text: config.feishuEmail
                        },
                        {
                            type: 'type',
                            selector: '#password',
                            text: config.feishuPassword
                        },
                        {
                            type: 'click',
                            selector: '#login-button'
                        },
                        {
                            type: 'wait',
                            timeout: 5000
                        }
                    ]
                };

                const response = await fetch('https://chrome.browserless.io/content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.browserlessApi}`
                    },
                    body: JSON.stringify(browserlessRequest)
                });

                if (response.ok) {
                    const result = await response.text();
                    
                    // æª¢æŸ¥æ˜¯å¦ç™»å…¥æˆåŠŸï¼ˆé€™è£¡éœ€è¦æ ¹æ“šå¯¦éš›ç¶²ç«™çµæ§‹èª¿æ•´ï¼‰
                    if (result.includes('dashboard') || result.includes('user-menu') || !result.includes('login-form')) {
                        updateStatus('feishu', 'online', 'ç™»å…¥æˆåŠŸ');
                        addLog('success', 'é£›é¼ é›»å•†ç™»å…¥æ¸¬è©¦æˆåŠŸ');
                    } else {
                        throw new Error('ç™»å…¥é©—è­‰å¤±æ•—');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateStatus('feishu', 'offline', 'é€£æ¥å¤±æ•—');
                addLog('error', `é£›é¼ é›»å•†é€£æ¥å¤±æ•—: ${error.message}`);
            }
        }

        // è‡ªå‹•åŒ–æ§åˆ¶
        function startAutomation() {
            if (!validateConfig()) {
                addLog('error', 'è«‹å…ˆå®Œæˆç³»çµ±é…ç½®');
                return;
            }

            automationRunning = true;
            updateStatus('automation', 'online', 'é‹è¡Œä¸­');
            addLog('success', 'è‡ªå‹•åŒ–ç³»çµ±å·²å•Ÿå‹•');

            // æ¨¡æ“¬å®šæœŸåŸ·è¡Œ
            startPeriodicTasks();
        }

        function stopAutomation() {
            automationRunning = false;
            updateStatus('automation', 'offline', 'å·²åœæ­¢');
            addLog('warning', 'è‡ªå‹•åŒ–ç³»çµ±å·²åœæ­¢');
        }

        function startPeriodicTasks() {
            if (!automationRunning) return;

            // æ¯ 2 å°æ™‚æª¢æŸ¥ä¸€æ¬¡åº«å­˜
            setTimeout(() => {
                if (automationRunning) {
                    runInventoryCheck();
                    startPeriodicTasks();
                }
            }, 2 * 60 * 60 * 1000);

            // æ¯ 4 å°æ™‚æŠ“å–ä¸€æ¬¡å•†å“
            setTimeout(() => {
                if (automationRunning) {
                    runProductScraping();
                }
            }, 4 * 60 * 60 * 1000);
        }

        // å…·é«”åŠŸèƒ½å¯¦ç¾
        async function runProductScraping() {
            addLog('info', 'é–‹å§‹æŠ“å–å•†å“è³‡æ–™...');
            
            try {
                const browserlessRequest = {
                    url: 'https://www.feishu.com.tw/admin/products',
                    authenticate: {
                        username: config.feishuEmail,
                        password: config.feishuPassword
                    },
                    waitFor: 30000,
                    elements: [{
                        selector: '.product-item',
                        type: 'html'
                    }]
                };

                const response = await fetch('https://chrome.browserless.io/scrape', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.browserlessApi}`
                    },
                    body: JSON.stringify(browserlessRequest)
                });

                if (response.ok) {
                    const result = await response.json();
                    addLog('success', `æˆåŠŸæŠ“å– ${result.data?.length || 0} ç­†å•†å“è³‡æ–™`);
                    
                    // å„²å­˜åˆ° Google Sheets
                    if (result.data && result.data.length > 0) {
                        await saveToGoogleSheets('products', result.data);
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                addLog('error', `å•†å“æŠ“å–å¤±æ•—: ${error.message}`);
            }
        }

        async function runInventoryCheck() {
            addLog('info', 'é–‹å§‹æª¢æŸ¥åº«å­˜ç‹€æ…‹...');
            
            try {
                // å¾ Google Sheets è®€å–æœ€æ–°å•†å“è³‡æ–™
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${config.sheetsId}/values/products!A:Z?key=${config.sheetsApi}`);
                
                if (response.ok) {
                    const result = await response.json();
                    const products = result.values || [];
                    
                    // åˆ†æåº«å­˜ç‹€æ³
                    const analysis = analyzeInventory(products);
                    
                    addLog('info', `åº«å­˜åˆ†æå®Œæˆ: ç¸½è¨ˆ ${analysis.total} ä»¶å•†å“`);
                    
                    if (analysis.lowStock.length > 0) {
                        addLog('warning', `ç™¼ç¾ ${analysis.lowStock.length} ä»¶ä½åº«å­˜å•†å“`);
                    }
                    
                    if (analysis.outOfStock.length > 0) {
                        addLog('error', `ç™¼ç¾ ${analysis.outOfStock.length} ä»¶ç¼ºè²¨å•†å“`);
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                addLog('error', `åº«å­˜æª¢æŸ¥å¤±æ•—: ${error.message}`);
            }
        }

        async function generateReport() {
            addLog('info', 'é–‹å§‹ç”Ÿæˆç³»çµ±å ±è¡¨...');
            
            try {
                const reportData = {
                    timestamp: new Date().toISOString(),
                    feishuStatus: document.getElementById('feishu-status').textContent,
                    browserlessStatus: document.getElementById('browserless-status').textContent,
                    sheetsStatus: document.getElementById('sheets-status').textContent,
                    automationStatus: document.getElementById('automation-status').textContent
                };

                // å„²å­˜å ±è¡¨åˆ° Google Sheets
                await saveToGoogleSheets('reports', [reportData]);
                addLog('success', 'ç³»çµ±å ±è¡¨å·²ç”Ÿæˆä¸¦å„²å­˜');
            } catch (error) {
                addLog('error', `å ±è¡¨ç”Ÿæˆå¤±æ•—: ${error.message}`);
            }
        }

        // è¼”åŠ©å‡½æ•¸
        function validateConfig() {
            return config.feishuEmail && config.feishuPassword && 
                   config.browserlessApi && config.sheetsApi && config.sheetsId;
        }

        function updateStatus(service, status, message) {
            const statusElement = document.getElementById(`${service}-status`);
            const checkElement = document.getElementById(`${service}-last-check`);
            
            if (statusElement) {
                const indicator = statusElement.querySelector('.status-indicator');
                const text = statusElement.querySelector('span:last-child');
                
                indicator.className = `status-indicator status-${status}`;
                text.textContent = message;
            }
            
            if (checkElement) {
                checkElement.textContent = `æœ€å¾Œæª¢æŸ¥: ${new Date().toLocaleString('zh-TW')}`;
            }
        }

        function addLog(type, message) {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('log-container').innerHTML = '';
            addLog('info', 'æ—¥èªŒå·²æ¸…é™¤');
        }

        function analyzeInventory(products) {
            const analysis = {
                total: products.length,
                lowStock: [],
                outOfStock: [],
                normal: []
            };

            products.forEach((product, index) => {
                if (index === 0) return; // è·³éæ¨™é¡Œè¡Œ
                
                const stock = parseInt(product[3]) || 0; // å‡è¨­åº«å­˜åœ¨ç¬¬4æ¬„
                
                if (stock === 0) {
                    analysis.outOfStock.push(product);
                } else if (stock <= 10) {
                    analysis.lowStock.push(product);
                } else {
                    analysis.normal.push(product);
                }
            });

            return analysis;
        }

        async function saveToGoogleSheets(sheetName, data) {
            try {
                const values = Array.isArray(data[0]) ? data : [data];
                
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${config.sheetsId}/values/${sheetName}!A:Z:append?valueInputOption=RAW&key=${config.sheetsApi}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        values: values
                    })
                });

                if (response.ok) {
                    addLog('success', `è³‡æ–™å·²å„²å­˜åˆ° Google Sheets (${sheetName})`);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                addLog('error', `Google Sheets å„²å­˜å¤±æ•—: ${error.message}`);
            }
        }
    </script>
</body>
</html>